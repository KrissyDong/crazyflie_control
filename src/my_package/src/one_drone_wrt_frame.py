#!/usr/bin/python3
import asyncio
import math
import time
import xml.etree.cElementTree as ET
from threading import Thread

import qtm
from scipy.spatial.transform import Rotation

import cflib.crtp
from cflib.crazyflie import Crazyflie
from cflib.crazyflie.log import LogConfig
from cflib.crazyflie.mem import MemoryElement
from cflib.crazyflie.mem import Poly4D
from cflib.crazyflie.syncCrazyflie import SyncCrazyflie
from cflib.crazyflie.syncLogger import SyncLogger
from cflib.utils import uri_helper
import rospy
import tf2_ros
from geometry_msgs.msg import TransformStamped
import threading
# add cf as a globle variable
cf = None
br = None
x = 0
y = 0
z = 0
rot_x = 0
rot_y = 0
rot_z = 0
rot_w = 0
orientation_std_dev = 8.0e-3


# URI to the Crazyflie to connect to
uri = uri_helper.uri_from_env(default='radio://0/80/1M/E7E7E7E7E7')
# uri = uri_helper.uri_from_env(default='radio://0/80/2M/E7E7E7E705')
.0



# Duration,x^0,x^1,x^2,x^3,x^4,x^5,x^6,x^7,y^0,y^1,y^2,y^3,y^4,y^5,y^6,y^7,z^0,z^1,z^2,z^3,z^4,z^5,z^6,z^7,yaw^0,yaw^1,yaw^2,yaw^3,yaw^4,yaw^5,yaw^6,yaw^7
figure8 = [
        [0.215297,-0.2,0,0,0,2.3694,-22.8104,83.5743,-110.183,-1.388,0,0,0,46.7502,-397.637,1301.36,-1567.61,0,0,0,0,-0.928553,4.72685,-7.51947,2.6769,0,0,0,0,0,0,0,0],[0.159097,-0.1995,0.00467919,0.00572824,-0.13776,4.40008,-42.205,176.928,-279.438,-1.3755,0.113488,0.0324133,-2.19848,-33.8375,520.384,-2309.78,3515.7,-0.0005,-0.00529041,-0.00286368,0.0918422,-9.62075,136.432,-707.456,1269.07,0,0,0,0,0,0,0,0],[0.169228,-0.1985,0.00820254,0.0107925,-0.0367148,-6.84401,101.227,-505.268,858.388,-1.3625,0.065282,0.128029,0.791556,-10.7181,1.35345,259.824,-641.608,-0.0015,-0.00575615,-0.00832725,-0.0183581,-10.3052,145.909,-713.442,1197.41,0,0,0,0,0,0,0,0],[0.170476,-0.197,0.0114967,0.00797298,-0.0144307,-5.21227,71.9094,-343.902,566.312,-1.349,0.0852742,0.0801546,0.690689,-60.8678,697.736,-3082.85,4858.05,-0.003,-0.00884363,-0.00398618,0.0108406,-15.3876,214.881,-1047.26,1752.32,0,0,0,0,0,0,0,0],[0.176381,-0.195,0.013542,0.00981459,-0.00598128,-6.28139,85.9731,-407.62,661.915,-1.335,0.0845466,0.0206848,0.0984806,-28.7718,368.972,-1699.15,2716.04,-0.005,-0.0104044,-0.00490747,-0.00299147,-17.539,237.762,-1120.04,1810.49,0,0,0,0,0,0,0,0],[0.178668,-0.1925,0.0166234,0.00692032,-0.00331391,-6.74328,91.2428,-426.958,684.093,-1.3205,0.0871593,0.0177026,0.119511,14.6134,-269.851,1441.78,-2491.4,-0.0075,-0.0124016,-0.00365013,0.00246314,-22.304,298.526,-1389.64,2219.39,0,0,0,0,0,0,0,0],[0.18545,-0.1895,0.0191945,0.00692775,8.43396e-05,-9.12664,118.602,-534.559,825.346,-1.3055,0.0710823,0.0022863,0.0251714,80.2082,-1055.62,4786.76,-7417.85,-0.0105,-0.0139551,-0.00346369,-7.4744e-05,-22.7816,294.028,-1318.95,2029.64,0,0,0,0,0,0,0,0],[0.187189,-0.186,0.0218285,0.00579391,-0.00117818,-6.79771,85.8494,-378.708,574.52,-1.29,0.0654856,-0.0026796,-0.0106268,110.466,-1416.45,6307.87,-9630.58,-0.014,-0.0154972,-0.00292209,0.000877513,-27.8166,355.849,-1582.08,2412.65,0,0,0,0,0,0,0,0],[0.199595,-0.182,0.0233405,0.00518362,-0.000418387,-9.39973,114.651,-483.084,695.869,-1.274,0.0642098,-0.000577934,0.00477555,81.6076,-981.595,4098.5,-5866.96,-0.018,-0.0168398,-0.00259165,0.000209371,-22.3503,268.209,-1118.44,1599.7,0,0,0,0,0,0,0,0],[0.199599,-0.1775,0.0260045,0.00327836,-0.00107546,-8.93812,109.38,-461.21,664.428,-1.2575,0.0639647,-0.00129293,-0.00236267,95.1071,-1143.94,4777.14,-6839.28,-0.0225,-0.0181196,-0.00232459,0.000661468,-28.1002,337.389,-1407.35,2013.31,0,0,0,0,0,0,0,0],[0.203723,-0.1725,0.0283468,0.00381535,-0.000558139,-10.0747,120.051,-494.441,696.566,-1.2405,0.0631382,-0.00119107,0.00216408,94.8628,-1117.54,4571.32,-6411.2,-0.0275,-0.0192182,-0.00190775,-0.000278769,-29.9138,351.8,-1437.6,2014.87,0,0,0,0,0,0,0,0],[0.206783,-0.167,0.0305846,0.00313545,-0.00241802,-7.51416,86.3275,-345.641,475.395,-1.223,0.0628975,-0.000420513,-0.00320203,97.5243,-1132.82,4567.23,-6312.16,-0.033,-0.0203898,-0.00205591,0.00153519,-32.6187,378.427,-1524.55,2105.9,0,0,0,0,0,0,0,0],[0.221271,-0.161,0.0310962,0.00191375,-0.00541752,-7.36664,80.4894,-303.543,391.832,-1.205,0.0616729,-0.00236193,0.00694671,70.0763,-759.047,2856.79,-3687.67,-0.039,-0.0210822,-0.000956967,-0.00270886,-24.6831,266.914,-1003.6,1294.69,0,0,0,0,0,0,0,0],[0.230266,-0.1545,0.0325317,0.00411555,-0.0114786,-7.58244,78.6393,-282.455,347.977,-1.1865,0.0627416,0.00259685,-0.0154041,60.864,-637.003,2310.1,-2869.43,-0.0455,-0.0226677,-0.00291806,0.0068483,-22.4976,235.343,-853.153,1059.4,0,0,0,0,0,0,0,0],[0.227123,-0.1475,0.0337134,0.00453719,-0.0299745,-5.57982,60.693,-222.319,277.255,-1.1675,0.0583425,-0.00896702,0.0350461,73.9309,-774.561,2829.71,-3551.75,-0.0525,-0.0218187,0.00226859,-0.0149873,-28.4649,297.584,-1085.87,1361.95,0,0,0,0,0,0,0,0],[0.248378,-0.14,0.0373822,0.0129742,-0.0630296,-4.04083,31.512,-87.6721,86.6952,-1.148,0.0673517,0.0184218,-0.0828831,47.1104,-466.133,1582.42,-1831.28,-0.06,-0.0267016,-0.00943577,0.036017,-18.921,187.375,-636.304,736.429,0,0,0,0,0,0,0,0],[0.245369,-0.132,0.0293771,0.0148175,0.0431508,-2.19519,18.9418,-54.148,50.2208,-1.128,0.0437552,-0.0464201,0.163935,53.6841,-495.334,1634.01,-1876.79,-0.068,-0.0174086,0.0187708,-0.0708743,-22.2595,204.643,-673.714,772.952,0,0,0,0,0,0,0,0],[0.312083,-0.1235,0.0457857,0.0457016,-0.334195,2.67154,-28.6864,96.8331,-102.188,-1.1075,0.0982345,0.0825777,-0.694077,13.2631,-118.276,357.273,-354.982,-0.0765,-0.0418612,-0.0370241,0.2999,-5.7052,50.9006,-153.765,152.776,0,0,0,0,0,0,0,0]
]

# f = [[0.702924, -5.0, 0.0, 0.0, 0.0, 2.09341, -4.93634, 4.3354, -1.3706, -5.0, 0.0, 0.0, 0.0, 2.0332,-4.65933, 3.93089, -1.18242, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.631857, -4.92929, 0.18923, -0.00146811, -0.100923, -2.59816, 8.7133, -10.2228, 4.20902, -4.92929, 0.186121, -0.0210391, -0.103419, -2.40996, 8.0826, -9.41695, 3.84697, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.654202, -4.85365, 0.0865392, 0.0242634, 0.0242582, 1.0378, -3.53545, 4.20436, -1.74143, -4.86086, 0.0686168, 0.0206248, 0.0250913, 1.08914, -3.83672, 4.66972, -1.96411, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.671924, -4.77314, 0.141022, 0.00743965, -0.0119174, -0.84067, 2.72376, -3.14457, 1.26962, -4.79503, 0.113392, 0.012031, 0.0122757, -1.19834, 3.5987, -4.00822, 1.58178, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.663234, -4.68782, 0.124532, 0.00602001, 0.00487211, 0.432213, -1.4602, 1.73132, -0.712945, -4.73212, 0.0849234, 0.0019344, 0.00504772, 0.398137, -1.48093, 1.87972, -0.814003, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.675522, -4.59781, 0.138958, 5.34195e-05, 0.0021467, 0.117311, -0.443482, 0.564433, -0.243455, -4.67245, 0.0883912, 0.00425172, 0.00219364, -0.158546, 0.323122, -0.231298, 0.0519502, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.675962, -4.5032, 0.139321, 0.00237811, 0.000867428, 0.477573, -1.65232, 2.00044, -0.834668, -4.61632, 0.0774118, 0.00165124, 0.000916317, 0.218653, -0.894399, 1.18924, -0.527043, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.662578, -4.40414, 0.145421, 0.00112315, 0.000421042, 1.10263, -3.97473, 4.98388, -2.14471, -4.56407, 0.0724343, 0.00285409, 0.000407567, 0.385576, -1.57923, 2.12197, -0.953802, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.695423, -4.30077, 0.148502, 0.00145843, 0.000136779, 0.435874, -1.47855, 1.75241, -0.71456, -4.51599, 0.0644837, 0.00239395, 0.000159664, 0.102329, -0.487743, 0.681177, -0.306351, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.681247, -4.19328, 0.152449, 0.00112505, 0.000116007, 1.07518, -3.76804, 4.59428, -1.9226, -4.47238, 0.0575243, 0.00264988, 7.76805e-05, 0.27727, -1.13402, 1.50225, -0.66218, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.714604, -4.08186, 0.155421, 0.00103218, 2.76717e-05, 0.410718, -1.36075, 1.57357, -0.62557, -4.43354, 0.0498565, 0.00257671, 1.2873e-05, 0.654244, -2.48845, 3.1006, -1.29199, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.699644, -3.96671, 0.158484, 0.000951867, 0.000113629, 1.02957, -3.52164, 4.18651, -1.70734, -4.39976, 0.0263773, -0.00132882, -2.47192e-06, 1.87663, -6.52924, 7.84252, -3.22054, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.733503, -3.84808, 0.16051, 0.000594741, 0.000133797, 0.383531, -1.23532, 1.39009, -0.537971, -4.3713, 0.0171957, -0.00130659, -1.30728e-05, 1.40517, -4.6196, 5.26323, -2.05399, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.71777, -3.7262, 0.16351, 0.000995278, 0.000400982, 0.990168, -3.33181, 3.88082, -1.54782, -4.34844, 0.0131221, -0.00136471, 3.16922e-05, 1.17162, -3.93994, 4.59002, -1.8313, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.752124, -3.60135, 0.162969, 0.000418337, 0.000820722, 0.321806, -0.984759, 1.06271, -0.396356, -4.33144, 0.00926366, -0.00124805, -7.68982e-05, 0.602282, -1.94523, 2.17058, -0.828378, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.735631, -3.47382, 0.169431, 0.00243011, 0.00199511, 1.04405, -3.57981, 4.16956, -1.64831, -4.32052, 0.00468496, -0.00151915, 0.000179646, 0.27153, -0.898836, 1.0276, -0.401677, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.770472, -3.3439, 0.157978, 0.00468583, 0.00447489, 0.0318202, 0.045043, -0.148463, 0.0809912, -4.31592, 0.00165963, -0.00087783, -0.000409222, -0.0986969, 0.270747, -0.270133, 0.0948099, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.753228, -3.21192, 0.187491, 0.011408, 0.0107981, 1.53997, -5.82395, 7.03787, -2.81719, -4.31784, -0.00516711, -0.00234972, 0.000982477, -0.540694, 1.75029, -1.95198, 0.743751, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.75779, -3.07819, 0.118948, 0.0268933, 0.0215711, 0.330653, -0.541827, 0.267016, -0.028309, -4.3265, -0.00311129, 0.00114153, -0.0019759, -0.828369, 2.49082, -2.65861, 0.983915, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.910633, -2.94309, 0.241872, 0.0295892, -0.0904369, 0.563339, -2.30402, 2.63977, -0.944137, -4.34205, -0.0217435, -0.00575652, 0.0080817, -0.541125, 1.51642, -1.44303, 0.464597, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]]

# f2 = [[0.702924, -5.0, 0.0, 0.0, 0.0, 2.09341, -4.93634, 4.3354, -1.3706, -5.0, 0.0, 0.0, 0.0, 2.0332, -4.65933, 3.93089, -1.18242, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.631857, -4.92929, 0.18923, -0.00146811, -0.100923, -2.59816, 8.7133, -10.2228, 4.20902, -4.92929, 0.186121, -0.0210391, -0.103419, -2.40996, 8.0826, -9.41695, 3.84697, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.654202, -4.85365, 0.0865392, 0.0242634, 0.0242582, 1.0378, -3.53545, 4.20436, -1.74143, -4.86086, 0.0686168, 0.0206248, 0.0250913, 1.08914, -3.83672, 4.66972, -1.96411, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.671924, -4.77314, 0.141022, 0.00743965, -0.0119174, -0.84067, 2.72376, -3.14457, 1.26962, -4.79503, 0.113392, 0.012031, 0.0122757, -1.19834, 3.5987, -4.00822, 1.58178, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.663234, -4.68782, 0.124532, 0.00602001, 0.00487211, 0.432213, -1.4602, 1.73132, -0.712945, -4.73212, 0.0849234, 0.0019344, 0.00504772, 0.398137, -1.48093, 1.87972, -0.814003, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.675522, -4.59781, 0.138958, 5.34195e-05, 0.0021467, 0.117311, -0.443482, 0.564433, -0.243455, -4.67245, 0.0883912, 0.00425172, 0.00219364, -0.158546, 0.323122, -0.231298, 0.0519502, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.675962, -4.5032, 0.139321, 0.00237811, 0.000867428, 0.477573, -1.65232, 2.00044, -0.834668, -4.61632, 0.0774118, 0.00165124, 0.000916317, 0.218653, -0.894399, 1.18924, -0.527043, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.662578, -4.40414, 0.145421, 0.00112315, 0.000421042, 1.10263, -3.97473, 4.98388, -2.14471, -4.56407, 0.0724343, 0.00285409, 0.000407567, 0.385576, -1.57923, 2.12197, -0.953802, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.695423, -4.30077, 0.148502, 0.00145843, 0.000136779, 0.435874, -1.47855, 1.75241, -0.71456, -4.51599, 0.0644837, 0.00239395, 0.000159664, 0.102329, -0.487743, 0.681177, -0.306351, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.681247, -4.19328, 0.152449, 0.00112505, 0.000116007, 1.07518, -3.76804, 4.59428, -1.9226, -4.47238, 0.0575243, 0.00264988, 7.76805e-05, 0.27727, -1.13402, 1.50225, -0.66218, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.714604, -4.08186, 0.155421, 0.00103218, 2.76717e-05, 0.410718, -1.36075, 1.57357, -0.62557, -4.43354, 0.0498565, 0.00257671, 1.2873e-05, 0.654244, -2.48845, 3.1006, -1.29199, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.699644, -3.96671, 0.158484, 0.000951867, 0.000113629, 1.02957, -3.52164, 4.18651, -1.70734, -4.39976, 0.0263773, -0.00132882, -2.47192e-06, 1.87663, -6.52924, 7.84252, -3.22054, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.733503, -3.84808, 0.16051, 0.000594741, 0.000133797, 0.383531, -1.23532, 1.39009, -0.537971, -4.3713, 0.0171957, -0.00130659, -1.30728e-05, 1.40517, -4.6196, 5.26323, -2.05399, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.71777, -3.7262, 0.16351, 0.000995278, 0.000400982, 0.990168, -3.33181, 3.88082, -1.54782, -4.34844, 0.0131221, -0.00136471, 3.16922e-05, 1.17162, -3.93994, 4.59002, -1.8313, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.752124, -3.60135, 0.162969, 0.000418337, 0.000820722, 0.321806, -0.984759, 1.06271, -0.396356, -4.33144, 0.00926366, -0.00124805, -7.68982e-05, 0.602282, -1.94523, 2.17058, -0.828378, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.735631, -3.47382, 0.169431, 0.00243011, 0.00199511, 1.04405, -3.57981, 4.16956, -1.64831, -4.32052, 0.00468496, -0.00151915, 0.000179646, 0.27153, -0.898836, 1.0276, -0.401677, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.770472, -3.3439, 0.157978, 0.00468583, 0.00447489, 0.0318202, 0.045043, -0.148463, 0.0809912, -4.31592, 0.00165963, -0.00087783, -0.000409222, -0.0986969, 0.270747, -0.270133, 0.0948099, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.753228, -3.21192, 0.187491, 0.011408, 0.0107981, 1.53997, -5.82395, 7.03787, -2.81719, -4.31784, -0.00516711, -0.00234972, 0.000982477, -0.540694, 1.75029, -1.95198, 0.743751, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.75779, -3.07819, 0.118948, 0.0268933, 0.0215711, 0.330653, -0.541827, 0.267016, -0.028309, -4.3265, -0.00311129, 0.00114153, -0.0019759, -0.828369, 2.49082, -2.65861, 0.983915, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0], [0.910633, -2.94309, 0.241872, 0.0295892, -0.0904369, 0.563339, -2.30402, 2.63977, -0.944137, -4.34205, -0.0217435, -0.00575652, 0.0080817, -0.541125, 1.51642, -1.44303, 0.464597, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]]

def callback(data):
    # This function gets called every time a new message arrives
    x = data.transform.translation.x
    y = data.transform.translation.y
    z = data.transform.translation.z 
    rot_x = data.transform.rotation.x
    rot_y = data.transform.rotation.y
    rot_z = data.transform.rotation.z
    rot_w = data.transform.rotation.w

    # br.sendTransform(data)

    # t = TransformStamped()
    # t.header.stamp = rospy.Time.now()
    # t.header.frame_id = "vicon/world"
    # t.child_frame_id = "map"
    # t.transform.translation.x = 0.0
    # t.transform.translation.y = 0.0
    # t.transform.translation.z = 0.0
    # t.transform.rotation.x = 0.0
    # t.transform.rotation.y = 0.0
    # t.transform.rotation.z = 0.0
    # t.transform.rotation.w = 1.0

    # br.sendTransform(t)

    # print(f'{rospy.get_caller_id()} I received {x, y, z, rot_x, rot_y, rot_z, rot_w}')

    # Set up a callback to handle data from QTM
    cf.extpos.send_extpose(x, y, z, rot_x, rot_y, rot_z, rot_w)
    # Perform additional operations here
    # also do cf send_extpose with x,y... from data which is a TransformStamped

def listener():
    # Initialize the node with a name



    # Spin() simply keeps python from exiting until this node is stopped
    rospy.spin()

def adjust_orientation_sensitivity(cf):
    cf.param.set_value('locSrv.extQuatStdDev', orientation_std_dev)


def activate_kalman_estimator(cf):
    cf.param.set_value('stabilizer.estimator', '2')

    # Set the std deviation for the quaternion data pushed into the
    # kalman filter. The default value seems to be a bit too low.
    cf.param.set_value('locSrv.extQuatStdDev', 0.06)



def upload_trajectory(cf, trajectory_id, trajectory):
    trajectory_mem = cf.mem.get_mems(MemoryElement.TYPE_TRAJ)[0]
    trajectory_mem.trajectory = []

    total_duration = 0
    for row in trajectory:
        duration = row[0]
        x = Poly4D.Poly(row[1:9])
        y = Poly4D.Poly(row[9:17])
        z = Poly4D.Poly(row[17:25])
        yaw = Poly4D.Poly(row[25:33])
        trajectory_mem.trajectory.append(Poly4D(duration, x, y, z, yaw))
        total_duration += duration

    trajectory_mem.write_data_sync()
    cf.high_level_commander.define_trajectory(trajectory_id, 0, len(trajectory_mem.trajectory))
    return total_duration

def run_sequence_basic(cf):
    commander = cf.high_level_commander

    commander.takeoff(1.0, 2.0)
    time.sleep(4.0)
    commander.land(0.0, 2.0)
    time.sleep(2.0)
    commander.stop()

def run_sequence(cf, trajectory_id, duration):
    commander = cf.high_level_commander

    commander.takeoff(1.0, 2.0)
    time.sleep(3.0)
    relative = True
    commander.start_trajectory(trajectory_id, 1.0, relative)
    time.sleep(duration)
    commander.land(0.0, 2.0)
    time.sleep(2)
    commander.stop()

# def run_sequence(cf):
#     commander = cf.high_level_commander

#     commander.takeoff(1.0, 2.0)
#     time.sleep(6.0)
#     commander.land(0.0, 2.0)
#     time.sleep(2)
#     commander.stop()

# def send_extpose_rot_matrix(cf, x, y, z, rot):
#     """
#     Send the current Crazyflie X, Y, Z position and attitude as a (3x3)
#     rotaton matrix. This is going to be forwarded to the Crazyflie's
#     position estimator.
#     """
#     quat = Rotation.from_matrix(rot).as_quat()

#     cf.extpos.send_extpose(x, y, z, quat[0], quat[1], quat[2], quat[3])

def wait_for_position_estimator(scf):
    print('Waiting for estimator to find position...')

    log_config = LogConfig(name='Kalman Variance', period_in_ms=50)
    log_config.add_variable('kalman.varPX', 'float')
    log_config.add_variable('kalman.varPY', 'float')
    log_config.add_variable('kalman.varPZ', 'float')




    var_y_history = [1000] * 10
    var_x_history = [1000] * 10
    var_z_history = [1000] * 10

    threshold = 0.001

    with SyncLogger(scf, log_config) as logger:
        for log_entry in logger:
            data = log_entry[1]

            var_x_history.append(data['kalman.varPX'])
            var_x_history.pop(0)
            var_y_history.append(data['kalman.varPY'])
            var_y_history.pop(0)
            var_z_history.append(data['kalman.varPZ'])
            var_z_history.pop(0)

            min_x = min(var_x_history)
            max_x = max(var_x_history)
            min_y = min(var_y_history)
            max_y = max(var_y_history)
            min_z = min(var_z_history)
            max_z = max(var_z_history)

            # print("{} {} {}".
            #       format(max_x - min_x, max_y - min_y, max_z - min_z))

            if (max_x - min_x) < threshold and (
                    max_y - min_y) < threshold and (
                    max_z - min_z) < threshold:
                break

def reset_estimator(cf):
    cf.param.set_value('kalman.resetEstimation', '1')
    time.sleep(0.1)
    cf.param.set_value('kalman.resetEstimation', '0')
    time.sleep(0.1)
    cf.param.set_value('locSrv.extPosStdDev', '0.01')
    # wait_for_position_estimator(cf)

if __name__ == '__main__':
    cflib.crtp.init_drivers()
    trajectory_id = 1

    with SyncCrazyflie(uri, cf=Crazyflie(rw_cache='./cache')) as scf:
        cf = scf.cf
        # print("Starting Listener" )

            # connect to crazytflie (cf object) through crazyradio
        rospy.init_node('kris_crazyflie_publisher', anonymous=True)
        print("Initialized node")
        
        # br = tf2_ros.TransformBroadcaster()

        # Subscribe to the 'transform_topic' topic and register the callback
        rospy.Subscriber('vicon/crazy_2/crazy_2', TransformStamped, callback)
        print("Subscribed to topic")

        listener_thread = threading.Thread(target=listener)
        listener_thread.start()
        time.sleep(1)

        log_config = LogConfig(name='Position', period_in_ms=50)
        log_config.add_variable('stateEstimate.x', 'float')
        log_config.add_variable('stateEstimate.y', 'float')
        log_config.add_variable('stateEstimate.z', 'float')

        scf.cf.log.add_config(log_config)
        def log_callback(timestamp, data, log_config):
            # print(f'Estimate: {timestamp}: {data}')
            pass
        log_config.data_received_cb.add_callback(log_callback)

        log_config.start()

        cf.param.set_value('commander.enHighLevel', '1')
        adjust_orientation_sensitivity(cf)
        activate_kalman_estimator(cf)

        duration = upload_trajectory(cf, 1, figure8)
        reset_estimator(cf)
        run_sequence(cf, 1, duration)
        
        # print(duration)
        # run_sequence_basic(cf)




    # once sending pose is done, add code to send waypoints to high level commander